<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–ó–∞–≤—É—á.PRO v1.7</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; touch-action: pan-y; }
        body { overscroll-behavior-y: contain; }
        
        .swipe-container { position: relative; overflow: hidden; border-radius: 1.5rem; background: #ef4444; margin-bottom: 0.75rem; }
        .swipe-item { position: relative; z-index: 10; background: white; transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .swipe-action { 
            position: absolute; right: 0; top: 0; bottom: 0; width: 100px; 
            color: white; display: flex; align-items: center; 
            justify-content: center; font-size: 0.7rem; font-weight: 900;
        }

        .toast {
            position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%) translateY(100px);
            background: #1e293b; color: white; padding: 0.75rem 1.5rem; border-radius: 1rem;
            transition: transform 0.3s ease; z-index: 1000;
        }
        .toast.show { transform: translateX(-50%) translateY(0); }

        @media print {
            .no-print { display: none !important; }
            .record-card { border: 1px solid #eee; break-inside: avoid; }
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-24">

    <div class="max-w-2xl mx-auto px-4 py-6">
        <!-- Header -->
        <header class="flex justify-between items-center mb-6 no-print">
            <h1 class="text-2xl font-black tracking-tighter italic">–ó–ê–í–£–ß<span class="text-blue-600">.PRO</span></h1>
            <div class="flex gap-3">
                <button onclick="exportJSON()" class="text-slate-400 text-sm">JSON</button>
                <button onclick="window.print()" class="text-blue-600 text-sm font-bold">–ü–ï–ß–ê–¢–¨</button>
            </div>
        </header>

        <!-- Stats -->
        <div class="grid grid-cols-4 gap-2 mb-6 no-print">
            <div class="bg-white p-3 rounded-2xl border border-slate-100 text-center shadow-sm">
                <div id="statTotal" class="text-lg font-black">0</div>
                <div class="text-[8px] font-bold text-slate-400 uppercase">–í—Å–µ–≥–æ</div>
            </div>
            <div class="bg-white p-3 rounded-2xl border-l-4 border-l-blue-500 text-center shadow-sm">
                <div id="stat100" class="text-lg font-black text-blue-600">0</div>
                <div class="text-[8px] font-bold text-slate-400 uppercase font-black">–û–∫–Ω–∞</div>
            </div>
            <div class="bg-white p-3 rounded-2xl border-l-4 border-l-amber-500 text-center shadow-sm">
                <div id="stat50" class="text-lg font-black text-amber-500">0</div>
                <div class="text-[8px] font-bold text-slate-400 uppercase font-black">50%</div>
            </div>
            <div class="bg-white p-3 rounded-2xl border border-slate-100 text-center shadow-sm">
                <div id="statMonth" class="text-lg font-black text-slate-700">0</div>
                <div class="text-[8px] font-bold text-slate-400 uppercase">–ú–µ—Å—è—Ü</div>
            </div>
        </div>

        <!-- Filter Bar -->
        <div class="mb-6 no-print flex gap-2">
            <input type="text" id="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –§–ò–û –∏–ª–∏ –ø—Ä–µ–¥–º–µ—Ç—É..." oninput="render()" 
                class="flex-1 bg-white border border-slate-200 rounded-xl px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
            <button onclick="clearFilter()" class="bg-slate-200 px-3 rounded-xl text-xs font-bold text-slate-500 uppercase tracking-tighter">–°–±—Ä–æ—Å</button>
        </div>

        <!-- Journal -->
        <div id="mobileBody" class="space-y-1"></div>
    </div>

    <!-- FAB -->
    <button onclick="openForm()" class="fixed bottom-8 right-6 w-14 h-14 bg-blue-600 text-white rounded-full shadow-2xl text-3xl font-light z-50 flex items-center justify-center no-print active:scale-90 transition">+</button>

    <!-- Modal -->
    <div id="modal" class="fixed inset-0 bg-slate-900/40 hidden items-end sm:items-center justify-center z-[100] no-print backdrop-blur-md">
        <div class="bg-white w-full sm:max-w-md rounded-t-[2rem] p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-6 px-2">
                <h3 class="text-xl font-black uppercase italic tracking-tighter">–ù–æ–≤–∞—è –∑–∞–º–µ–Ω–∞</h3>
                <button onclick="closeForm()" class="text-slate-300 text-2xl">&times;</button>
            </div>
            <form id="mainForm" class="space-y-4">
                <div class="flex gap-2">
                    <input type="date" id="fDate" required class="flex-1 bg-slate-100 p-4 rounded-xl border-none font-bold text-blue-600">
                    <select id="fType" class="bg-slate-100 p-4 rounded-xl border-none font-black text-xs uppercase">
                        <option value="100">100% (–û–∫–Ω–æ)</option>
                        <option value="50">50% (–£—Ä–æ–∫)</option>
                    </select>
                </div>
                <input list="subjects" id="fSubject" placeholder="–ü—Ä–µ–¥–º–µ—Ç" required class="w-full bg-slate-100 p-4 rounded-xl border-none">
                <input list="teachers" id="fWho" placeholder="–ö—Ç–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (–§–ò–û)" required class="w-full bg-slate-100 p-4 rounded-xl border-none text-sm">
                <input list="teachers" id="fBy" placeholder="–ö—Ç–æ –∑–∞–º–µ–Ω—è–µ—Ç (–§–ò–û)" required class="w-full bg-slate-100 p-4 rounded-xl border-none text-sm">
                <button type="submit" class="w-full bg-blue-600 text-white font-black py-4 rounded-xl shadow-lg uppercase tracking-widest text-sm">–î–æ–±–∞–≤–∏—Ç—å –≤ –±–∞–∑—É</button>
            </form>
        </div>
    </div>

    <div id="toast" class="toast"></div>
    <datalist id="teachers"></datalist>
    <datalist id="subjects"></datalist>

    <script>
        let reps = JSON.parse(localStorage.getItem('v17_data')) || [];
        let master = JSON.parse(localStorage.getItem('v17_master')) || {t:[], s:[]};
        let startX = 0;

        const save = () => {
            localStorage.setItem('v17_data', JSON.stringify(reps));
            localStorage.setItem('v17_master', JSON.stringify(master));
        };

        const render = () => {
            const container = document.getElementById('mobileBody');
            const search = document.getElementById('search').value.toLowerCase();
            
            const filtered = reps.filter(r => 
                r.by.toLowerCase().includes(search) || 
                r.who.toLowerCase().includes(search) || 
                r.subject.toLowerCase().includes(search)
            ).sort((a,b) => new Date(b.date) - new Date(a.date));
            
            container.innerHTML = filtered.map(r => {
                const d = new Date(r.date);
                return `
                <div class="swipe-container shadow-sm border border-slate-100" id="cont-${r.id}">
                    <div class="swipe-action" onclick="del(${r.id})">–£–î–ê–õ–ò–¢–¨ üóëÔ∏è</div>
                    <div class="swipe-item p-4 flex items-center gap-4" 
                         onclick="resetSwipes()"
                         ontouchstart="ts(event)" 
                         ontouchmove="tm(event, this)" 
                         ontouchend="te(event, this)">
                        
                        <div class="flex flex-col items-center bg-slate-50 w-12 py-1 rounded-lg">
                            <span class="text-lg font-black leading-none">${d.getDate()}</span>
                            <span class="text-[8px] uppercase font-bold text-slate-400">${d.toLocaleDateString('ru-RU',{month:'short'}).replace('.','')}</span>
                        </div>

                        <div class="flex-1 min-w-0">
                            <div class="text-[9px] font-black uppercase text-blue-500 tracking-wider truncate">${r.subject}</div>
                            <div class="text-xs font-bold text-slate-800 truncate leading-tight">${r.by}</div>
                            <div class="text-[10px] text-slate-400 truncate tracking-tight italic">–∑–∞–º–µ–Ω—è–µ—Ç: ${r.who}</div>
                        </div>

                        <div class="text-right">
                            <div class="text-sm font-black ${r.type == '100' ? 'text-blue-600' : 'text-amber-500'} italic">${r.type}%</div>
                            <div class="text-[7px] font-bold px-1.5 py-0.5 rounded border ${r.type == '100' ? 'border-blue-200 text-blue-400' : 'border-amber-200 text-amber-400'} uppercase">${r.type == '100' ? '–û–ö–ù–û' : '–£–†–û–ö'}</div>
                        </div>
                    </div>
                </div>
                `;
            }).join('') || '<div class="text-center py-20 text-slate-300 font-bold uppercase text-xs tracking-widest">–ñ—É—Ä–Ω–∞–ª –ø—É—Å—Ç</div>';
            
            updateStats();
            updateDatalists();
        };

        // Swipe Logic
        const ts = e => { startX = e.touches[0].clientX; resetSwipes(e.currentTarget); };
        const tm = (e, el) => {
            let moveX = e.touches[0].clientX - startX;
            if (moveX < 0 && moveX > -120) el.style.transform = `translateX(${moveX}px)`;
        };
        const te = (e, el) => {
            let finalX = parseInt(el.style.transform.replace(/[^-0-9]/g, '')) || 0;
            el.style.transform = finalX < -50 ? 'translateX(-100px)' : 'translateX(0)';
        };
        const resetSwipes = (except) => {
            document.querySelectorAll('.swipe-item').forEach(el => {
                if (el !== except) el.style.transform = 'translateX(0)';
            });
        };

        const del = id => {
            if(confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?')) {
                reps = reps.filter(r => r.id !== id);
                save(); render(); showToast('–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞');
            }
        };

        const showToast = msg => {
            const t = document.getElementById('toast');
            t.textContent = msg; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        };

        const openForm = () => document.getElementById('modal').classList.replace('hidden', 'flex');
        const closeForm = () => document.getElementById('modal').classList.replace('flex', 'hidden');

        document.getElementById('mainForm').onsubmit = function(e) {
            e.preventDefault();
            const rec = {
                id: Date.now(),
                date: document.getElementById('fDate').value,
                type: document.getElementById('fType').value,
                subject: document.getElementById('fSubject').value.trim(),
                who: document.getElementById('fWho').value.trim(),
                by: document.getElementById('fBy').value.trim()
            };
            reps.push(rec);
            if(!master.t.includes(rec.who)) master.t.push(rec.who);
            if(!master.t.includes(rec.by)) master.t.push(rec.by);
            if(!master.s.includes(rec.subject)) master.s.push(rec.subject);
            save(); render(); closeForm(); showToast('‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
            this.reset(); document.getElementById('fDate').valueAsDate = new Date();
        };

        const updateStats = () => {
            document.getElementById('statTotal').textContent = reps.length;
            document.getElementById('stat100').textContent = reps.filter(r => r.type == '100').length;
            document.getElementById('stat50').textContent = reps.filter(r => r.type == '50').length;
            document.getElementById('statMonth').textContent = reps.filter(r => new Date(r.date).getMonth() === new Date().getMonth()).length;
        };

        const updateDatalists = () => {
            document.getElementById('teachers').innerHTML = master.t.map(t => `<option value="${t}">`).join('');
            document.getElementById('subjects').innerHTML = master.s.map(s => `<option value="${s}">`).join('');
        };

        const clearFilter = () => { document.getElementById('search').value = ''; render(); };

        function exportJSON() {
            const blob = new Blob([JSON.stringify({reps, master})], {type: 'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = `backup_${new Date().toISOString().slice(0,10)}.json`; a.click();
        }

        document.getElementById('fDate').valueAsDate = new Date();
        render();
    </script>
</body>
</html>
