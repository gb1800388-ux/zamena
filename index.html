<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–ó–∞–≤—É—á-–£–ª—å—Ç—Ä–∞ v1.6</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        :root { --p100: #2563eb; --p50: #f59e0b; }
        * { -webkit-tap-highlight-color: transparent; touch-action: pan-y; }
        body { overscroll-behavior-y: contain; padding-top: env(safe-area-inset-top); }
        
        /* Swipe styles */
        .swipe-container { position: relative; overflow: hidden; border-radius: 1.5rem; transition: transform 0.2s; }
        .swipe-item { position: relative; z-index: 10; background: white; transition: transform 0.3s ease-out; }
        .swipe-action { 
            position: absolute; right: 0; top: 0; bottom: 0; width: 100px; 
            background: #ef4444; color: white; display: flex; align-items: center; 
            justify-content: center; font-weight: bold; border-radius: 0 1.5rem 1.5rem 0;
        }

        .toast {
            position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%) translateY(100px);
            background: #1e293b; color: white; padding: 0.75rem 1.5rem; border-radius: 1rem;
            transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); z-index: 1000;
        }
        .toast.show { transform: translateX(-50%) translateY(0); }

        @media print {
            .no-print { display: none !important; }
            .print-area { padding: 0; }
            table { width: 100%; border-collapse: collapse; }
            th, td { border: 1px solid black !important; padding: 8px; text-align: left; }
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-10">

    <div class="max-w-4xl mx-auto px-4 py-6">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8 no-print">
            <h1 class="text-3xl font-black text-slate-900 tracking-tighter">–ó–ê–í–£–ß<span class="text-blue-600">.PRO</span></h1>
            <button onclick="exportJSON()" class="text-slate-400 hover:text-blue-600 transition">–≠–∫—Å–ø–æ—Ä—Ç üì•</button>
        </header>

        <!-- Stats -->
        <div class="grid grid-cols-4 gap-3 mb-8 no-print">
            <div class="bg-white p-4 rounded-3xl shadow-sm border border-slate-100 text-center">
                <div id="statTotal" class="text-2xl font-black">0</div>
                <div class="text-[9px] uppercase font-bold text-slate-400">–í—Å–µ–≥–æ</div>
            </div>
            <div class="bg-blue-600 p-4 rounded-3xl shadow-lg text-center text-white">
                <div id="stat100" class="text-2xl font-black">0</div>
                <div class="text-[9px] uppercase font-bold opacity-80">–û–∫–Ω–∞</div>
            </div>
            <div class="bg-amber-500 p-4 rounded-3xl shadow-lg text-center text-white">
                <div id="stat50" class="text-2xl font-black">0</div>
                <div class="text-[9px] uppercase font-bold opacity-80">50%</div>
            </div>
            <div class="bg-white p-4 rounded-3xl shadow-sm border border-slate-100 text-center">
                <div id="statMonth" class="text-2xl font-black">0</div>
                <div class="text-[9px] uppercase font-bold text-slate-400">–ú–µ—Å—è—Ü</div>
            </div>
        </div>

        <!-- Mobile Records -->
        <div id="mobileBody" class="space-y-4"></div>
    </div>

    <!-- FAB -->
    <button onclick="openForm()" class="fixed bottom-8 right-6 w-16 h-16 bg-blue-600 text-white rounded-full shadow-2xl text-4xl font-light z-50 no-print">+</button>

    <!-- Modal -->
    <div id="modal" class="fixed inset-0 bg-slate-900/40 hidden items-end sm:items-center justify-center z-[100] no-print backdrop-blur-md">
        <div class="bg-white w-full sm:max-w-md rounded-t-[2.5rem] sm:rounded-[2rem] p-8 shadow-2xl transition-all">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-black text-slate-800">–ù–æ–≤–∞—è –∑–∞–º–µ–Ω–∞</h3>
                <button onclick="closeForm()" class="text-slate-300 text-3xl">&times;</button>
            </div>
            <form id="mainForm" class="space-y-5">
                <div class="grid grid-cols-2 gap-4">
                    <input type="date" id="fDate" required class="bg-slate-100 p-4 rounded-2xl border-none font-bold text-blue-600">
                    <select id="fType" class="bg-slate-100 p-4 rounded-2xl border-none font-bold">
                        <option value="100">üî• 100% –û–∫–Ω–æ</option>
                        <option value="50">‚è≥ 50% –£—Ä–æ–∫</option>
                    </select>
                </div>
                <input list="subjects" id="fSubject" placeholder="–ü—Ä–µ–¥–º–µ—Ç" required class="w-full bg-slate-100 p-4 rounded-2xl border-none">
                <input list="teachers" id="fWho" placeholder="–ö—Ç–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç" required class="w-full bg-slate-100 p-4 rounded-2xl border-none">
                <input list="teachers" id="fBy" placeholder="–ö—Ç–æ –∑–∞–º–µ–Ω—è–µ—Ç" required class="w-full bg-slate-100 p-4 rounded-2xl border-none">
                <button type="submit" class="w-full bg-blue-600 text-white font-black py-5 rounded-2xl shadow-xl active:scale-95 transition">–°–û–•–†–ê–ù–ò–¢–¨ –ó–ê–ü–ò–°–¨</button>
            </form>
        </div>
    </div>

    <div id="toast" class="toast">–ó–∞–ø–∏—Å—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞</div>
    <datalist id="teachers"></datalist>
    <datalist id="subjects"></datalist>

    <script>
        let reps = JSON.parse(localStorage.getItem('v16_data')) || [];
        let master = JSON.parse(localStorage.getItem('v16_master')) || {t:[], s:[]};

        const save = () => {
            localStorage.setItem('v16_data', JSON.stringify(reps));
            localStorage.setItem('v16_master', JSON.stringify(master));
        };

        const render = () => {
            const container = document.getElementById('mobileBody');
            const sorted = [...reps].sort((a,b) => new Date(b.date) - new Date(a.date));
            
            container.innerHTML = sorted.map(r => {
                const d = new Date(r.date);
                const day = d.getDate();
                const month = d.toLocaleDateString('ru-RU', { month: 'short' }).replace('.', '');
                
                return `
                <div class="swipe-container shadow-sm border border-slate-100">
                    <div class="swipe-action" onclick="confirmDelete(${r.id})">–£–î–ê–õ–ò–¢–¨</div>
                    <div class="swipe-item p-5 flex items-center gap-5" 
                         ontouchstart="handleTouchStart(event)" 
                         ontouchmove="handleTouchMove(event, this)" 
                         ontouchend="handleTouchEnd(event, this)">
                        
                        <!-- Date Block -->
                        <div class="flex flex-col items-center bg-slate-50 px-3 py-2 rounded-xl min-w-[55px]">
                            <span class="text-xl font-black text-slate-800 leading-none">${day}</span>
                            <span class="text-[10px] uppercase font-bold text-slate-400">${month}</span>
                        </div>

                        <!-- Info -->
                        <div class="flex-1">
                            <div class="text-[10px] font-black uppercase tracking-widest text-blue-500 mb-0.5">${r.subject}</div>
                            <div class="text-sm font-bold text-slate-800 line-clamp-1">${r.by} <span class="text-slate-300 font-normal">–≤–º–µ—Å—Ç–æ</span> ${r.who}</div>
                        </div>

                        <!-- Badge -->
                        <div class="text-right">
                            <div class="text-lg font-black ${r.type == '100' ? 'text-blue-600' : 'text-amber-500'}">${r.type}%</div>
                            <div class="text-[8px] font-bold text-slate-400 uppercase tracking-tighter">${r.type == '100' ? '–û–ö–ù–û' : '–°–û–í–ú–ï–©–ï–ù–ò–ï'}</div>
                        </div>
                    </div>
                </div>
                `;
            }).join('') || '<div class="text-center py-20 text-slate-300 font-bold uppercase tracking-widest italic">–ñ—É—Ä–Ω–∞–ª –ø—É—Å—Ç</div>';
            
            updateStats();
            updateDatalists();
        };

        // Swipe Logic
        let startX = 0;
        const handleTouchStart = e => startX = e.touches[0].clientX;
        const handleTouchMove = (e, el) => {
            let moveX = e.touches[0].clientX - startX;
            if (moveX < 0 && moveX > -120) el.style.transform = `translateX(${moveX}px)`;
        };
        const handleTouchEnd = (e, el) => {
            let finalX = parseInt(el.style.transform.replace(/[^-0-9]/g, '')) || 0;
            el.style.transform = finalX < -60 ? 'translateX(-100px)' : 'translateX(0)';
        };

        const confirmDelete = id => {
            if(confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–º–µ–Ω—É?')) {
                reps = reps.filter(r => r.id !== id);
                save();
                render();
                showToast('–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞');
            } else {
                render(); // Reset swipe state
            }
        };

        const showToast = msg => {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        };

        const openForm = () => document.getElementById('modal').classList.replace('hidden', 'flex');
        const closeForm = () => document.getElementById('modal').classList.replace('flex', 'hidden');

        document.getElementById('mainForm').onsubmit = function(e) {
            e.preventDefault();
            const rec = {
                id: Date.now(),
                date: document.getElementById('fDate').value,
                type: document.getElementById('fType').value,
                subject: document.getElementById('fSubject').value.trim(),
                who: document.getElementById('fWho').value.trim(),
                by: document.getElementById('fBy').value.trim()
            };
            
            reps.push(rec);
            if(!master.t.includes(rec.who)) master.t.push(rec.who);
            if(!master.t.includes(rec.by)) master.t.push(rec.by);
            if(!master.s.includes(rec.subject)) master.s.push(rec.subject);
            
            save();
            render();
            closeForm();
            showToast('‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –∂—É—Ä–Ω–∞–ª');
            this.reset();
            document.getElementById('fDate').valueAsDate = new Date();
        };

        const updateStats = () => {
            document.getElementById('statTotal').textContent = reps.length;
            document.getElementById('stat100').textContent = reps.filter(r => r.type == '100').length;
            document.getElementById('stat50').textContent = reps.filter(r => r.type == '50').length;
            document.getElementById('statMonth').textContent = reps.filter(r => new Date(r.date).getMonth() === new Date().getMonth()).length;
        };

        const updateDatalists = () => {
            document.getElementById('teachers').innerHTML = master.t.map(t => `<option value="${t}">`).join('');
            document.getElementById('subjects').innerHTML = master.s.map(s => `<option value="${s}">`).join('');
        };

        function exportJSON() {
            const blob = new Blob([JSON.stringify({reps, master})], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `zavuch_v16_backup.json`;
            a.click();
        }

        document.getElementById('fDate').valueAsDate = new Date();
        render();
    </script>
</body>
</html>
