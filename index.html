
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Завуч.PRO v6.1</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; -webkit-touch-callout: none; }
        body { 
            overscroll-behavior-y: contain;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            min-height: 100vh;
            font-family: system-ui, -apple-system, sans-serif;
        }
        .safe-top { padding-top: env(safe-area-inset-top); }
        .glass { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        .glass-dark { background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }

        /* Исправленный свайп */
        .swipe-container { position: relative; overflow: hidden; border-radius: 1.5rem; margin-bottom: 0.75rem; background: #ef4444; }
        .swipe-item { 
            position: relative; z-index: 10; background: white; 
            transition: transform 0.25s ease-out;
            touch-action: pan-y; /* Плавность на iPhone */
        }
        .swipe-action { position: absolute; right: 0; top: 0; bottom: 0; width: 80px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 900; font-size: 0.6rem; }

        .modal-sheet {
            position: fixed; bottom: 0; left: 0; right: 0; background: white;
            border-radius: 2.5rem 2.5rem 0 0; z-index: 101;
            transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            max-height: 94vh; overflow-y: auto;
        }
        .modal-sheet.active { transform: translateY(0); }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 100; visibility: hidden; opacity: 0; transition: 0.3s; }
        .modal-overlay.active { visibility: visible; opacity: 1; }

        .big-input { font-size: 1.25rem; font-weight: 700; text-align: center; background: #f1f5f9; border: 2px solid transparent; border-radius: 1rem; padding: 1rem; width: 100%; outline: none; }
        .big-input:focus { border-color: #6366f1; background: white; }

        .lesson-btn { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 900; background: #f1f5f9; cursor: pointer; }
        .lesson-btn.active { background: #6366f1; color: white; transform: scale(1.1); }

        .toast { position: fixed; bottom: 5rem; left: 50%; transform: translateX(-50%) translateY(100px); background: #1e293b; color: white; padding: 1rem 2rem; border-radius: 1rem; transition: 0.3s; z-index: 1000; font-weight: 600; }
        .toast.show { transform: translateX(-50%) translateY(0); }

        .fab { position: fixed; bottom: 2rem; right: 1.5rem; width: 64px; height: 64px; background: #f59e0b; color: white; border-radius: 50%; font-size: 32px; display: flex; align-items: center; justify-content: center; shadow: 0 10px 25px rgba(245,158,11,0.4); z-index: 50; border: none; }
    </style>
</head>
<body class="safe-top">

    <div class="max-w-xl mx-auto px-4 py-6">
        <header class="flex justify-between items-center mb-6 no-print">
            <h1 class="text-2xl font-black text-white italic tracking-tighter">ЗАВУЧ<span class="text-yellow-300">.PRO</span></h1>
            <div class="flex gap-2 text-white/80 text-xs font-bold">
                <button onclick="exportJSON()">Backup</button>
                <button onclick="window.print()">Печать</button>
            </div>
        </header>

        <!-- Stats -->
        <div class="grid grid-cols-4 gap-2 mb-6 no-print">
            <div class="glass p-3 rounded-2xl text-center shadow-sm">
                <div id="statTotal" class="text-lg font-black text-slate-800">0</div>
                <div class="text-[8px] font-bold text-slate-400 uppercase">Всего</div>
            </div>
            <div class="glass p-3 rounded-2xl border-b-4 border-blue-500 text-center shadow-sm">
                <div id="stat100" class="text-lg font-black text-blue-600">0</div>
                <div class="text-[8px] font-bold text-slate-400 uppercase leading-none">Окно</div>
            </div>
            <div class="glass p-3 rounded-2xl border-b-4 border-amber-500 text-center shadow-sm">
                <div id="stat50" class="text-lg font-black text-amber-600">0</div>
                <div class="text-[8px] font-bold text-slate-400 uppercase leading-none">Урок</div>
            </div>
            <div class="glass p-3 rounded-2xl text-center shadow-sm">
                <div id="statMonth" class="text-lg font-black text-slate-700">0</div>
                <div class="text-[8px] font-bold text-slate-400 uppercase leading-none">Месяц</div>
            </div>
        </div>

        <!-- Filter -->
        <div class="mb-4 no-print">
            <input type="text" id="search" placeholder="Поиск (ФИО, Предмет)..." oninput="render()" class="w-full glass border-none rounded-xl px-5 py-3 text-sm focus:ring-2 focus:ring-white">
        </div>

        <div id="journal" class="space-y-1"></div>
    </div>

    <button onclick="openWizard()" class="fab no-print">+</button>

    <!-- Wizard -->
    <div id="overlay" class="modal-overlay" onclick="closeWizard()"></div>
    <div id="wizard" class="modal-sheet p-8">
        <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-6"></div>

        <div id="step1" class="step active space-y-4">
            <h3 class="text-xl font-black text-center text-slate-800 uppercase italic">Когда замена?</h3>
            <input type="date" id="wDate" class="big-input text-blue-600 font-bold">
            <div class="flex justify-between gap-2" id="lessonGrid">
                <!-- Lessons 1-7 -->
            </div>
            <button onclick="next(2)" class="w-full bg-indigo-600 text-white font-black py-4 rounded-2xl shadow-lg">ДАЛЕЕ →</button>
        </div>

        <div id="step2" class="step hidden space-y-4 text-center">
            <h3 class="text-xl font-black text-slate-800 uppercase italic">Детали</h3>
            <input type="text" id="wClass" placeholder="Класс (напр. 5А)" class="big-input uppercase">
            <input type="text" id="wSubject" placeholder="Предмет" class="big-input">
            <div class="flex gap-2">
                <button onclick="next(1)" class="w-1/3 bg-slate-100 py-4 rounded-2xl font-bold">←</button>
                <button onclick="next(3)" class="w-2/3 bg-indigo-600 text-white font-black py-4 rounded-2xl shadow-lg">ДАЛЕЕ →</button>
            </div>
        </div>

        <div id="step3" class="step hidden space-y-4 text-center">
            <h3 class="text-xl font-black text-slate-800 uppercase italic">Кто и кого?</h3>
            <input type="text" id="wWho" placeholder="Кто отсутствует" class="big-input">
            <input type="text" id="wBy" placeholder="Кто заменяет" class="big-input">
            <div class="flex gap-4 mb-4">
                <button onclick="setType('100')" id="btn100" class="flex-1 p-4 rounded-2xl font-black border-4 border-blue-500 bg-blue-50 text-blue-700">100% ОКНО</button>
                <button onclick="setType('50')" id="btn50" class="flex-1 p-4 rounded-2xl font-black border-4 border-transparent bg-slate-50 text-slate-400">50% УРОК</button>
            </div>
            <div id="summary" class="bg-slate-50 p-4 rounded-xl text-left text-xs space-y-1 font-medium text-slate-500"></div>
            <div class="flex gap-2">
                <button onclick="next(2)" class="w-1/3 bg-slate-100 py-4 rounded-2xl font-bold">←</button>
                <button onclick="saveRec()" class="w-2/3 bg-emerald-500 text-white font-black py-4 rounded-2xl shadow-lg shadow-emerald-200 uppercase tracking-widest">ДОБАВИТЬ ✓</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        let reps = JSON.parse(localStorage.getItem('v61_reps')) || [];
        let curStep = 1;
        let curLesson = 1;
        let curType = '100';

        // Инициализация сетки уроков
        const lg = document.getElementById('lessonGrid');
        for(let i=1; i<=7; i++) {
            lg.innerHTML += `<div class="lesson-btn ${i==1?'active':''}" onclick="setLesson(${i}, this)">${i}</div>`;
        }

        function setLesson(num, el) {
            curLesson = num;
            document.querySelectorAll('.lesson-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
        }

        function setType(t) {
            curType = t;
            document.getElementById('btn100').className = t=='100' ? 'flex-1 p-4 rounded-2xl font-black border-4 border-blue-500 bg-blue-50 text-blue-700' : 'flex-1 p-4 rounded-2xl font-black border-4 border-transparent bg-slate-50 text-slate-400';
            document.getElementById('btn50').className = t=='50' ? 'flex-1 p-4 rounded-2xl font-black border-4 border-amber-500 bg-amber-50 text-amber-700' : 'flex-1 p-4 rounded-2xl font-black border-4 border-transparent bg-slate-50 text-slate-400';
            updateSummary();
        }

        function openWizard() {
            curStep = 1; next(1);
            document.getElementById('wDate').valueAsDate = new Date();
            document.getElementById('wizard').classList.add('active');
            document.getElementById('overlay').classList.add('active');
        }

        function closeWizard() {
            document.getElementById('wizard').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        }

        function next(step) {
            document.querySelectorAll('.step').forEach(s => s.classList.add('hidden'));
            document.getElementById('step' + step).classList.remove('hidden');
            if(step == 3) updateSummary();
        }

        function updateSummary() {
            const s = document.getElementById('summary');
            const subject = document.getElementById('wSubject').value || '---';
            const who = document.getElementById('wWho').value || '---';
            const by = document.getElementById('wBy').value || '---';
            s.innerHTML = `
                <div><b class="text-slate-800 uppercase">Предмет:</b> ${subject}</div>
                <div><b class="text-slate-800 uppercase">Заменяет:</b> ${by}</div>
                <div><b class="text-slate-800 uppercase">Вместо:</b> ${who}</div>
                <div><b class="text-slate-800 uppercase">Оплата:</b> ${curType}% (${curType=='100'?'Окно':'Совмещение'})</div>
            `;
        }

        function saveRec() {
            const rec = {
                id: Date.now(),
                date: document.getElementById('wDate').value,
                lesson: curLesson,
                cls: document.getElementById('wClass').value.trim().toUpperCase(),
                subject: document.getElementById('wSubject').value.trim(),
                who: document.getElementById('wWho').value.trim(),
                by: document.getElementById('wBy').value.trim(),
                type: curType
            };

            if(!rec.date || !rec.cls || !rec.subject || !rec.by) return showToast('Заполните все поля!');

            // Проверка на дубликаты
            const isDup = reps.find(r => r.date == rec.date && r.lesson == rec.lesson && r.cls == rec.cls);
            if(isDup && !confirm('Внимание! В этом классе на этом уроке уже есть замена. Продолжить?')) return;

            reps.push(rec);
            localStorage.setItem('v61_reps', JSON.stringify(reps));
            render();
            closeWizard();
            showToast('✓ Сохранено в журнал');
            document.getElementById('mainForm').reset();
        }

        function render() {
            const container = document.getElementById('journal');
            const search = document.getElementById('search').value.toLowerCase();
            const filtered = reps.filter(r => 
                r.by.toLowerCase().includes(search) || r.subject.toLowerCase().includes(search) || r.cls.toLowerCase().includes(search)
            ).sort((a,b) => new Date(b.date) - new Date(a.date));

            container.innerHTML = filtered.map(r => `
                <div class="swipe-container">
                    <div class="swipe-action" onclick="del(${r.id})">УДАЛИТЬ</div>
                    <div class="swipe-item p-4 flex items-center gap-4" 
                         ontouchstart="ts(event)" ontouchmove="tm(event, this)" ontouchend="te(event, this)">
                        <div class="flex flex-col items-center bg-slate-50 min-w-[45px] py-1 rounded-xl">
                            <span class="text-lg font-black leading-none">${new Date(r.date).getDate()}</span>
                            <span class="text-[8px] font-bold text-slate-400 uppercase">${new Date(r.date).toLocaleDateString('ru-RU',{month:'short'}).replace('.','')}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2">
                                <span class="text-[9px] font-black bg-blue-100 text-blue-600 px-1.5 rounded uppercase">${r.cls}</span>
                                <span class="text-[9px] font-bold text-slate-400 italic truncate tracking-tight">${r.subject}</span>
                            </div>
                            <div class="text-sm font-black text-slate-800 truncate">${r.by}</div>
                            <div class="text-[10px] text-slate-400 truncate">вместо: ${r.who}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-black ${r.type=='100'?'text-blue-600':'text-amber-500'} italic leading-none">${r.type}%</div>
                            <div class="text-[7px] font-black text-slate-300 uppercase">${r.type=='100'?'ОКНО':'УРОК'}</div>
                        </div>
                    </div>
                </div>
            `).join('') || '<div class="py-20 text-center text-white/50 font-bold uppercase text-xs italic tracking-widest">Журнал пуст</div>';

            updateStats();
        }

        // Swipe Logic
        let sX = 0;
        const ts = e => { sX = e.touches[0].clientX; resetSwipes(); };
        const tm = (e, el) => {
            let mX = e.touches[0].clientX - sX;
            if (mX < 0 && mX > -120) el.style.transform = `translateX(${mX}px)`;
        };
        const te = (e, el) => {
            let fX = parseInt(el.style.transform.replace(/[^-0-9]/g,'')) || 0;
            el.style.transform = fX < -60 ? 'translateX(-80px)' : 'translateX(0)';
        };
        const resetSwipes = () => document.querySelectorAll('.swipe-item').forEach(el => el.style.transform = 'translateX(0)');

        function del(id) {
            if(confirm('Удалить?')) {
                reps = reps.filter(r => r.id !== id);
                localStorage.setItem('v61_reps', JSON.stringify(reps));
                render();
            }
        }

        function showToast(m) {
            const t = document.getElementById('toast'); t.textContent = m;
            t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000);
        }

        function updateStats() {
            document.getElementById('statTotal').textContent = reps.length;
            document.getElementById('stat100').textContent = reps.filter(r => r.type == '100').length;
            document.getElementById('stat50').textContent = reps.filter(r => r.type == '50').length;
            document.getElementById('statMonth').textContent = reps.filter(r => new Date(r.date).getMonth() == new Date().getMonth()).length;
        }

        function exportJSON() {
            const b = new Blob([JSON.stringify(reps)], {type:'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(b);
            a.download = `zavuch_backup_${new Date().toISOString().slice(0,10)}.json`; a.click();
        }

        render();
    </script>
</body>
</html>
